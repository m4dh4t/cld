## Task 3: Test the performance of Datastore writes

In this task you will performance test the App Engine platform with a
load generator. You will compare the performance of normal request
processing and request processing that involves Datastore write
operations.

As the Servlets are deployed with Automatic Scaling, there is a danger
of consuming a lot of resources while testing, and burning through a
lot of money. Google gave you a coupon with some money that was put
into a billing account. Projects can have spending limits, but by
default it is unlimited. Before starting the performance test, you
have to set a reasonable daily spending limit.

Set a daily spending limit on the project as follows:

- In the Cloud Platform console navigate to **App Engine** >
  **Settings**. Click on **Edit**. Enter a daily spending limit of
  **$1.00**. (Note: Google has removed this functionality in January 2020. There is no replacement for it yet. Skip this step, but observe how many credits you have left before and after the performance tests. You can also limit the number of instances with an optional configuration of the autoscaling algorithm: In the file `appengine-web.xml` in the `<automatic-scaling>` element add a `<max-instances>` element with a small value (3, 4, ...). See <https://cloud.google.com/appengine/docs/standard/java/config/appref#scaling_elements>. An alternative is to use **Budgets & alerts**. In the Cloud Platform console navigate to **Billing** > **Budgets & alerts**. Create a new budget for the month for an amount of **$1.00** and optionally set the actions associated with the alert.)

Conduct the performance tests as follows:

1. You should already have vegeta installed from previous labs. If not, see <https://blog.absyah.dev/super-simple-guide-for-load-testing-using-vegeta#heading-install-vegeta>.

2. First test the performance of normal request processing using the
   Servlet generated by the wizard.

   - Prepare an "attack" using vegeta.

   - In the App Engine console open the **Dashboard**.

   - Run the attack.

   - In the dashboard observe the graph of the incoming requests, the
     number of instances and the latency.

3. Test the performance of the Servlet that writes to the Datastore.

4. At the end of the tests observe in detail how much resources were
   used. In the console click on **Quota Details**.

5. If you are running out of resources because of the monthly spending
   limit, increase it carefully by a dollar or two.

Deliverables:

- For each performance test, write the command used to generate the attack with vegeta and copy the file generated by the vegeta plot command.

  **Vegeta attack command for the Hello Servlet:**

  ```bash
  echo "GET https://labgae-420611.ew.r.appspot.com/hello" | vegeta attack -duration=30s -rate=10 | tee ./tests/results/hello.bin | vegeta report > ./tests/reports/hello.txt
  ```

  **Vegeta plot for the Hello Servlet:**

  [Hello Servlet performance plot](./tests/plots/hello.html)

  **Vegeta attack command for the Datastore write Servlet:**

  ```bash
  echo "GET https://labgae-420611.ew.r.appspot.com/datastorewrite?_kind=book&_key=837094&author=John%20Steinbeck&title=The%20Grapes%20of%20Wrath" | vegeta attack -duration=30s -rate=10 | tee ./tests/results/datastorewrite.bin | vegeta report > ./tests/reports/datastorewrite.txt
  ```

  **Vegeta plot for the Datastore write Servlet:**
  
  [Datastore write Servlet performance plot](./tests/plots/datastorewrite.html)

- What response times do you observe for each Servlet?

  ```
  As we can see in the tests reports, the average response time for the Hello Servlet is 45ms against 72ms for the Datastore write Servlet. It is expected that the Datastore write Servlet takes more time to respond because it has to perform a write operation on the Datastore, which is a more complex operation than just returning a simple response.
  ```

- Compare the response times shown by vegeta with the App Engine
  console. Explain the difference.

  ```
  The average response times shown by Google Cloud Platform are 17ms for the Hello Servlet and 42ms for the Datastore write Servlet. We can see that the response times shown in the App Engine console are lower than the response times shown in Vegeta. This is because the response times shown by vegeta are the times that the client takes to receive a response from the server. The response times shown in the App Engine console are the times that the server takes to process the request and send a response back to the client. The difference between the two is the network latency between the client and the server.
  ```

- How many resources have you used to run these tests? From the
  **Quota Details** view of the console determine the non-zero resource
  quotas (**Daily quota** different from 0%). Explain each with a sentence.
  To get a sense of everything that is measured click on **Show resources not in use**.

  ```
  The non-zero resource usage are as follows:

  | Resource                                  | Usage today          | Explanation                                                       |
  |-------------------------------------------|----------------------|-------------------------------------------------------------------|
  | Cloud Firestore API Calls                 | 302                  | Tracks the number of API requests made.                           |
  | Cloud Firestore Stored Data               | 0.000034 GB          | Represents the total volume of data stored.                       |
  | Data Sent to Cloud Firestore API          | 0.000034 GB          | Measures the amount of data sent to Firestore via API.            |
  | Data Received from Cloud Firestore API    | 0.000019 GB          | Measures the amount of data received from Firestore via API.      |
  | Cloud Firestore Entity Writes             | 0.0003 Million Ops   | Counts the operations involving data writes to Firestore entities.|
  ```

- Let's suppose you become suspicious that the algorithm for the automatic scaling of
  instances is not working correctly. Imagine a way in which the algorithm could be broken. Which measures shown in the console would you use to detect this failure?

  ```
  If the algorithm for the automatic scaling of instances is not working correctly, we could detect this failure by observing the number of instances that are running. If the number of instances is not increasing or decreasing according to the number of requests, then the algorithm is not working correctly. We can see the number of instances in the App Engine console in the **Dashboard**. We can also see the number of instances in the **Quota Details** view of the console by looking at the **Instances** resource. The consequences of this failure are that the application may not be able to handle the load of requests, or that the application may be consuming more resources than necessary, which would be reflected on either the response times or the resource usage.
  ```

## Troubleshooting

If your Servlet that writes to the Datastore works OK on your local
machine, but you get a server error when running it in the Google
cloud, have a look at the logs (hamburger menu > Logs). If you see a
NoClassDefFoundError related to the Datastore you have run into a
[problem that was reported to Google on March 22, 2018](https://issuetracker.google.com/issues/76144204). The
problem is that the library for the Datastore,
`appengine-api-1.0-sdk`, is missing. Previously it was automatically
included by Google.

Here is a workaround:

- Create a new project (Google App Engine Standard Environment) that
  has Maven activated (option on the first screen of the wizard).
- Edit the file `pom.xml`: In the dependency declaration for
  `appengine-api-1.0-sdk` change the scope from `provided` to
  `compile` (this will include the dependency in the jar that is
  uploaded to Google).
- _Clean_ the project.
